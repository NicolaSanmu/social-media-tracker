{% extends "base.html" %}

{% block title %}{{ account.display_name }} - Social Media Tracker{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 返回链接 -->
    <a href="/accounts" class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        返回账号列表
    </a>

    <!-- 账号信息头部 -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl {% if account.platform == 'instagram' %}platform-instagram{% elif account.platform == 'tiktok' %}platform-tiktok{% elif account.platform == 'youtube' %}platform-youtube{% elif account.platform == 'twitter' %}platform-twitter{% else %}bg-gray-500{% endif %}">
                    {{ account.display_name[0].upper() if account.display_name else account.username[0].upper() }}
                </div>
                <div class="ml-4">
                    <h1 class="text-2xl font-bold text-gray-900">{{ account.display_name }}</h1>
                    <p class="text-gray-500">@{{ account.username }}</p>
                    <span class="inline-block mt-1 px-2 py-1 text-xs font-medium text-white rounded {% if account.platform == 'instagram' %}platform-instagram{% elif account.platform == 'tiktok' %}platform-tiktok{% elif account.platform == 'youtube' %}platform-youtube{% elif account.platform == 'twitter' %}platform-twitter{% else %}bg-gray-500{% endif %}">
                        {{ account.platform.upper() }}
                    </span>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="collectData()" id="collectBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    采集数据
                </button>
                <a href="https://{% if account.platform == 'instagram' %}instagram.com/{{ account.username }}{% elif account.platform == 'tiktok' %}tiktok.com/@{{ account.username }}{% elif account.platform == 'youtube' %}youtube.com/channel/{{ account.account_id }}{% elif account.platform == 'twitter' %}x.com/{{ account.username }}{% else %}#{% endif %}" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    访问主页
                </a>
                <button onclick="deleteAccount()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    删除
                </button>
            </div>
        </div>

        <!-- 统计数据 -->
        <div class="mt-6 grid grid-cols-2 gap-4">
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900">{{ "{:,}".format(account.follower_count or 0) }}</div>
                <div class="text-sm text-gray-500">粉丝</div>
            </div>
            <div class="text-center p-4 bg-gray-50 rounded-lg">
                <div class="text-2xl font-bold text-gray-900">{{ "{:,}".format(account.following_count or 0) }}</div>
                <div class="text-sm text-gray-500">关注</div>
            </div>
        </div>

        {% if account.bio %}
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-600">{{ account.bio }}</p>
        </div>
        {% endif %}
    </div>

    <!-- 趋势图表 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 互动趋势 -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">互动趋势</h2>
            <canvas id="engagementChart" height="200"></canvas>
        </div>

        <!-- 粉丝变化 -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">粉丝变化</h2>
            <canvas id="followersChart" height="200"></canvas>
        </div>
    </div>

    <!-- 帖子列表 -->
    <div class="bg-white rounded-lg shadow">
        <!-- 筛选器区域 -->
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <h2 class="text-lg font-medium text-gray-900">帖子列表 ({{ posts|length }})</h2>

                <!-- 筛选控件 -->
                <div class="flex flex-wrap items-center gap-4">
                    <!-- 日期范围 -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">日期范围:</label>
                        <input type="date" id="dateFrom" value="{{ date_from }}"
                            class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-400">至</span>
                        <input type="date" id="dateTo" value="{{ date_to }}"
                            class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="applyDateFilter()" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700">
                            筛选
                        </button>
                        {% if date_from or date_to %}
                        <button onclick="clearDateFilter()" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300">
                            清除
                        </button>
                        {% endif %}
                    </div>

                    <!-- 排序控件 -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">排序:</label>
                        <select id="sortBy" onchange="applySorting()" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="published_at" {% if sort_by == 'published_at' %}selected{% endif %}>发布时间</option>
                            <option value="views" {% if sort_by == 'views' %}selected{% endif %}>播放量</option>
                            <option value="likes" {% if sort_by == 'likes' %}selected{% endif %}>点赞数</option>
                            <option value="comments" {% if sort_by == 'comments' %}selected{% endif %}>评论数</option>
                            <option value="shares" {% if sort_by == 'shares' %}selected{% endif %}>分享数</option>
                        </select>
                        <select id="sortOrder" onchange="applySorting()" class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="desc" {% if order == 'desc' %}selected{% endif %}>降序</option>
                            <option value="asc" {% if order == 'asc' %}selected{% endif %}>升序</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 快捷日期按钮 -->
            <div class="mt-3 flex flex-wrap gap-2">
                <span class="text-sm text-gray-500">快捷选择:</span>
                <button onclick="setDateRange(7)" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">最近7天</button>
                <button onclick="setDateRange(30)" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">最近30天</button>
                <button onclick="setDateRange(90)" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">最近90天</button>
                <button onclick="setThisMonth()" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">本月</button>
                <button onclick="setLastMonth()" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">上月</button>
                <button onclick="setThisYear()" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">今年</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortByColumn('published_at')">
                            发布时间 {% if sort_by == 'published_at' %}{% if order == 'desc' %}&darr;{% else %}&uarr;{% endif %}{% endif %}
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">内容</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortByColumn('views')">
                            播放量 {% if sort_by == 'views' %}{% if order == 'desc' %}&darr;{% else %}&uarr;{% endif %}{% endif %}
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortByColumn('likes')">
                            点赞 {% if sort_by == 'likes' %}{% if order == 'desc' %}&darr;{% else %}&uarr;{% endif %}{% endif %}
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortByColumn('comments')">
                            评论 {% if sort_by == 'comments' %}{% if order == 'desc' %}&darr;{% else %}&uarr;{% endif %}{% endif %}
                        </th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortByColumn('shares')">
                            分享 {% if sort_by == 'shares' %}{% if order == 'desc' %}&darr;{% else %}&uarr;{% endif %}{% endif %}
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">链接</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for post in posts %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ post.published_at[:10] if post.published_at else 'N/A' }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                            {{ post.caption[:60] + '...' if post.caption and post.caption|length > 60 else post.caption or '无描述' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-medium">
                            {{ "{:,}".format(post.views) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(post.likes) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(post.comments) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                            {{ "{:,}".format(post.shares) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <a href="{{ post.url }}" target="_blank" class="text-blue-600 hover:text-blue-900">
                                <svg class="w-5 h-5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 当前筛选状态
    const currentSortBy = '{{ sort_by }}';
    const currentOrder = '{{ order }}';
    const currentDateFrom = '{{ date_from }}';
    const currentDateTo = '{{ date_to }}';
    const accountId = {{ account.id }};

    // 构建URL参数
    function buildUrl() {
        const sortBy = document.getElementById('sortBy').value;
        const order = document.getElementById('sortOrder').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        let url = `/account/${accountId}?sort_by=${sortBy}&order=${order}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        return url;
    }

    function applySorting() {
        window.location.href = buildUrl();
    }

    function applyDateFilter() {
        window.location.href = buildUrl();
    }

    function clearDateFilter() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        window.location.href = buildUrl();
    }

    function sortByColumn(column) {
        const sortBy = document.getElementById('sortBy');
        const sortOrder = document.getElementById('sortOrder');

        if (currentSortBy === column) {
            sortOrder.value = currentOrder === 'desc' ? 'asc' : 'desc';
        } else {
            sortBy.value = column;
            sortOrder.value = 'desc';
        }

        applySorting();
    }

    // 快捷日期选择
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function setDateRange(days) {
        const today = new Date();
        const from = new Date();
        from.setDate(today.getDate() - days);

        document.getElementById('dateFrom').value = formatDate(from);
        document.getElementById('dateTo').value = formatDate(today);
        applyDateFilter();
    }

    function setThisMonth() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

        document.getElementById('dateFrom').value = formatDate(firstDay);
        document.getElementById('dateTo').value = formatDate(today);
        applyDateFilter();
    }

    function setLastMonth() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);

        document.getElementById('dateFrom').value = formatDate(firstDay);
        document.getElementById('dateTo').value = formatDate(lastDay);
        applyDateFilter();
    }

    function setThisYear() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), 0, 1);

        document.getElementById('dateFrom').value = formatDate(firstDay);
        document.getElementById('dateTo').value = formatDate(today);
        applyDateFilter();
    }

    // 按回车键触发筛选
    document.getElementById('dateFrom').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') applyDateFilter();
    });
    document.getElementById('dateTo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') applyDateFilter();
    });

    // 采集数据
    async function collectData() {
        const btn = document.getElementById('collectBtn');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>采集中...';

        try {
            const response = await fetch(`/api/account/${accountId}/collect`, {
                method: 'POST'
            });
            const data = await response.json();

            if (response.ok) {
                alert(data.message + '\n\n页面将在3秒后刷新...');
                setTimeout(() => window.location.reload(), 3000);
            } else {
                alert('采集失败: ' + (data.error || '未知错误'));
            }
        } catch (error) {
            alert('网络错误，请重试');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // 删除账号
    async function deleteAccount() {
        if (!confirm('确定要删除这个账号及其所有数据吗？此操作不可撤销。')) {
            return;
        }

        try {
            const response = await fetch(`/api/account/${accountId}`, {
                method: 'DELETE'
            });
            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                window.location.href = '/accounts';
            } else {
                alert('删除失败: ' + (data.error || '未知错误'));
            }
        } catch (error) {
            alert('网络错误，请重试');
        }
    }

    // 趋势数据
    const trends = {{ trends | tojson }};

    // 互动趋势图
    const engagementCtx = document.getElementById('engagementChart').getContext('2d');
    new Chart(engagementCtx, {
        type: 'line',
        data: {
            labels: trends.daily_metrics.map(d => d.date),
            datasets: [
                {
                    label: '播放量',
                    data: trends.daily_metrics.map(d => d.views),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: '点赞',
                    data: trends.daily_metrics.map(d => d.likes),
                    borderColor: 'rgb(236, 72, 153)',
                    backgroundColor: 'rgba(236, 72, 153, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: '评论',
                    data: trends.daily_metrics.map(d => d.comments),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 粉丝变化图
    const followersCtx = document.getElementById('followersChart').getContext('2d');
    new Chart(followersCtx, {
        type: 'line',
        data: {
            labels: trends.account_history.map(d => d.date ? d.date.substring(0, 10) : ''),
            datasets: [
                {
                    label: '粉丝数',
                    data: trends.account_history.map(d => d.followers),
                    borderColor: 'rgb(139, 92, 246)',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
</script>
{% endblock %}
